<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Noahjo Shop — Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* MATCH THE ORIGINAL LOOK: compact centered page, pre block, same colors */
    body {
      font-family: Arial, Helvetica, sans-serif;
      padding: 24px;
      max-width: 900px;
      margin: auto;
      background: #f7fafc;
      color: #07203a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    h1 { color: #0a66c2; margin: 0 0 8px 0; font-size: 26px; }
    p.note { background:#fff8c6; padding:10px; border-radius:6px; margin: 8px 0; }
    pre#output {
      background:#f4f4f4;
      padding:10px;
      border-radius:6px;
      overflow:auto;
      white-space: pre-wrap;
      word-break: break-word;
      border: 1px solid #e9eef6;
    }

    /* subtle header bar with login/register inline like you asked */
    .topbar {
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    .brand { display:flex; gap:12px; align-items:center; }
    .logo {
      width:56px; height:56px; border-radius:10px;
      background: linear-gradient(135deg,#0a66c2,#58a0ff);
      display:flex; align-items:center; justify-content:center;
      color:white; font-weight:700; font-size:22px;
      box-shadow: 0 6px 18px rgba(10,20,40,0.06);
    }

    .controls { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .btn {
      background:#0a66c2; color:white; border:0; padding:8px 12px; border-radius:6px; cursor:pointer;
      font-weight:600; box-shadow: 0 4px 12px rgba(10,102,194,0.06);
    }
    .btn.ghost { background:transparent; color:#0a66c2; border:1px solid rgba(10,102,194,0.12); box-shadow:none; }

    .small { font-size:13px; color:#556; }

    /* layout */
    .grid { display:grid; grid-template-columns: 1fr 320px; gap:16px; margin-top:12px; }
    @media (max-width:880px) { .grid { grid-template-columns: 1fr; } .controls { display:none; } }

    /* card */
    .card { background:white; padding:14px; border-radius:8px; border:1px solid #eef3fb; box-shadow: 0 8px 28px rgba(10,20,40,0.03); }

    /* product list minimal rows */
    .product-row { display:flex; align-items:center; gap:12px; padding:8px 0; border-bottom:1px solid #f1f6fb; }
    .product-row img { width:110px; height:72px; object-fit:cover; border-radius:6px; }
    .product-meta { flex:1; }
    .product-title { font-weight:700; margin:0; }
    .product-cat { font-size:13px; color:#6b7280; margin-top:4px; }

    /* cart */
    .cart-item { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #eef4fb; }

    /* modal */
    .modal-backdrop {
      position:fixed; inset:0; background:rgba(6,12,26,0.4); display:flex; align-items:center; justify-content:center; z-index:9999;
    }
    .modal { width:92%; max-width:420px; background:white; border-radius:8px; padding:14px; box-shadow: 0 20px 60px rgba(8,18,40,0.18); }
    label { display:block; margin-top:8px; font-weight:600; }
    input[type="text"], input[type="password"], input[type="number"] { width:100%; padding:8px; border-radius:6px; border:1px solid #e6eef7; margin-top:6px; }

    /* tiny animation & helpers */
    .fade { animation: fade .18s ease; }
    @keyframes fade { from { opacity:0; transform: translateY(6px);} to { opacity:1; transform:none; } }

    .muted-note { color:#6b7280; font-size:13px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">N</div>
      <div>
        <h1>Noahjo Shop — Demo</h1>
        <div class="small">Simple demo storefront</div>
      </div>
    </div>

    <div class="controls">
      <div id="signed-as" class="small">Not signed in</div>
      <button id="btn-login" class="btn ghost">Login</button>
      <button id="btn-register" class="btn">Register</button>
      <button id="btn-cart" class="btn ghost">Cart (<span id="cart-count">0</span>)</button>
    </div>
  </div>

  <p class="note"><strong>Important:</strong> Replace <code>API_BASE</code> in the script if your backend runs on another host (e.g. the Railway/Vercel URL). Keep Stripe & admin secrets on the server only.</p>

  <div class="grid">
    <!-- left: products / product detail -->
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>Products</strong>
            <div class="small">Products are loaded from <code>/api/products</code></div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="search" type="text" placeholder="Search by title or category" style="padding:6px;border-radius:6px;border:1px solid #e6eef7" />
            <button id="btn-refresh" class="btn ghost">Refresh</button>
          </div>
        </div>

        <div id="products-root" style="margin-top:12px">
          <!-- original style: show JSON in pre -->
          <pre id="output">Loading products...</pre>
        </div>
      </div>

      <div id="product-detail" class="card" style="margin-top:12px; display:none"></div>

    </div>

    <!-- right: cart + user actions -->
    <aside>
      <div class="card">
        <strong>Cart</strong>
        <div id="cart-list" style="margin-top:10px"></div>

        <div style="display:flex;justify-content:space-between;margin-top:10px">
          <div class="small">Total</div>
          <div id="cart-total" style="font-weight:700">—</div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="btn-checkout" class="btn">Checkout</button>
          <button id="btn-clear" class="btn ghost">Clear</button>
        </div>

        <div id="checkout-msg" class="muted-note"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>User</strong>
        <div class="small">Check if email exists and request verification code</div>

        <label>Check email</label>
        <input id="check-email" type="text" placeholder="you@example.com" />
        <button id="btn-check" class="btn ghost" style="margin-top:8px">Check</button>
        <pre id="check-result" class="small">No check yet</pre>

        <label>Request verification code</label>
        <input id="req-email" type="text" placeholder="you@example.com" />
        <button id="btn-req" class="btn" style="margin-top:8px">Request code</button>
        <pre id="req-result" class="small">No code requested</pre>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="small">Privacy: admin/owner email is stored server-side only.</div>
      </div>
    </aside>
  </div>

  <!-- minimal footer -->
  <div style="max-width:900px;margin:auto;padding-top:12px;" class="small muted-note">This single file connects to a backend. Make sure your backend provides the expected routes.</div>

  <!-- modal root -->
  <div id="modal-root"></div>

<script>
/* Single-file frontend
   - Styled to look like the original demo page
   - Adds login/register (username + email verification code), products, cart, reviews, checkout
   - Stores JWT in localStorage under 'nj_token'
   - API base: change API_BASE if backend is at different host
*/

const API_BASE = location.origin; // <-- change this if your backend is on a different domain
const TOKEN_KEY = 'nj_token';
let state = {
  token: localStorage.getItem(TOKEN_KEY) || null,
  user: null,
  products: [],
  cart: []
};

/* --- helper functions --- */
function parseJwt(token){
  try {
    const p = token.split('.')[1];
    return JSON.parse(atob(p.replace(/-/g,'+').replace(/_/g,'/')));
  } catch(e){ return null; }
}
function setToken(token){
  state.token = token;
  if(token) localStorage.setItem(TOKEN_KEY, token); else localStorage.removeItem(TOKEN_KEY);
  state.user = token ? parseJwt(token) : null;
  refreshHeader();
}
function authHeader(){ return state.token ? { 'Authorization': 'Bearer ' + state.token } : {}; }
function jsonHeaders(){ return { 'Content-Type': 'application/json' }; }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function formatPrice(p){ return '$' + Number(p).toFixed(2); }

/* initialize token from localStorage */
setToken(state.token);

/* UI wiring */
document.getElementById('btn-refresh').addEventListener('click', ()=> loadProducts(true));
document.getElementById('btn-check').addEventListener('click', checkEmail);
document.getElementById('btn-req').addEventListener('click', requestCode);
document.getElementById('btn-login').addEventListener('click', ()=> openModal('login'));
document.getElementById('btn-register').addEventListener('click', ()=> openModal('register'));
document.getElementById('btn-cart').addEventListener('click', ()=> window.scrollTo({ top: 200, behavior:'smooth' }));
document.getElementById('btn-clear').addEventListener('click', ()=> { state.cart=[]; saveCart(); renderCart(); });
document.getElementById('btn-checkout').addEventListener('click', checkout);

/* --- Products --- */
async function loadProducts(renderCards=false){
  const out = document.getElementById('output');
  out.textContent = 'Loading products...';
  try {
    const res = await fetch(API_BASE + '/api/products');
    if(!res.ok) throw new Error('Failed: ' + res.status);
    const data = await res.json();
    state.products = data;
    // show JSON in pre like your original demo
    out.textContent = JSON.stringify(data, null, 2);
    // also create a compact product listing below pre
    renderProductCards();
  } catch(err){
    out.textContent = 'Error loading products: ' + (err.message || err);
  }
}

function renderProductCards(){
  // below pre, show simple rows
  let container = document.getElementById('products-root');
  // ensure pre remains the first child
  const pre = document.getElementById('output');
  // remove existing card area if present
  const existing = document.getElementById('cards-area');
  if(existing) existing.remove();
  const cards = document.createElement('div');
  cards.id = 'cards-area';
  cards.style.marginTop = '12px';
  for(const p of state.products){
    const row = document.createElement('div');
    row.className = 'product-row';
    const img = (p.images && p.images[0]) ? p.images[0] : 'https://via.placeholder.com/160x110?text=Product';
    row.innerHTML = `
      <img src="${escapeHtml(img)}" alt="${escapeHtml(p.title)}" />
      <div class="product-meta">
        <div class="product-title">${escapeHtml(p.title)}</div>
        <div class="product-cat">${escapeHtml(p.category || '')}</div>
        <div class="small" style="margin-top:6px">${escapeHtml(p.short_desc || '')}</div>
      </div>
      <div style="text-align:right">
        <div class="price">${formatPrice(p.price)}</div>
        <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn ghost" onclick='openProduct("${p.id}")'>Open</button>
          <button class="btn" onclick='addToCart("${p.id}",1)'>Add</button>
        </div>
      </div>
    `;
    cards.appendChild(row);
  }
  container.appendChild(cards);
}

/* Product detail + reviews */
function openProduct(id){
  const p = state.products.find(x=>x.id===id);
  if(!p) return;
  const det = document.getElementById('product-detail');
  det.style.display = 'block';
  det.innerHTML = `
    <h3 style="margin:0">${escapeHtml(p.title)} <span class="small">— ${escapeHtml(p.category||'')}</span></h3>
    <div class="small" style="margin-top:6px">${escapeHtml(p.long_desc || p.short_desc || '')}</div>
    <div style="margin-top:8px"><strong>${formatPrice(p.price)}</strong></div>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button class="btn" onclick='addToCart("${p.id}",1)'>Add to cart</button>
      <button class="btn ghost" onclick='loadReviews("${p.id}")'>Reviews</button>
    </div>
    <div id="reviews-area" style="margin-top:12px"></div>
  `;
  loadReviews(id);
}

/* Reviews */
async function loadReviews(productId){
  const area = document.getElementById('reviews-area');
  area.innerHTML = '<div class="small">Loading reviews…</div>';
  try {
    const res = await fetch(API_BASE + '/api/products/' + encodeURIComponent(productId) + '/reviews');
    if(!res.ok) throw new Error('Failed to load reviews');
    const rows = await res.json();
    let html = '';
    if(rows.length === 0) html += '<div class="small">No reviews yet</div>';
    for(const r of rows){
      html += `<div style="border-top:1px solid #f1f6fb;padding-top:8px;margin-top:8px">
        <div style="display:flex;justify-content:space-between"><div><strong>${escapeHtml(r.author_email_actual || r.author_email || 'User')}</strong> <span class="small">${escapeHtml(r.created_at||'')}</span></div><div>${r.rating}★</div></div>
        <div style="margin-top:6px">${escapeHtml(r.text||'')}</div>`;
      // if the JWT payload indicates admin or author, show delete button (UI only)
      const payload = parseJwt(state.token || '') || {};
      if(payload && (payload.is_admin || String(payload.id) === String(r.author_id))){
        html += `<div style="margin-top:6px"><button class="btn ghost" onclick='deleteReview(${r.id})'>Delete</button></div>`;
      }
      html += `</div>`;
    }
    if(state.token){
      html += `<div style="margin-top:12px"><h4>Post a review</h4><label>Rating</label><input id="rev-rating" type="number" min="1" max="5" value="5" /><label>Text</label><input id="rev-text" /><div style="margin-top:8px"><button class="btn" onclick='postReview("${productId}")'>Post</button></div><pre id="rev-res" class="small"></pre></div>`;
    } else {
      html += `<div class="small" style="margin-top:12px">Login to post reviews.</div>`;
    }
    area.innerHTML = html;
  } catch(e){
    area.innerHTML = '<div class="small">Failed to load reviews</div>';
  }
}

async function postReview(productId){
  const rating = Number(document.getElementById('rev-rating').value || 0);
  const text = document.getElementById('rev-text').value || '';
  const out = document.getElementById('rev-res');
  out.textContent = 'Posting...';
  try {
    const res = await fetch(API_BASE + '/api/products/' + encodeURIComponent(productId) + '/reviews', {
      method:'POST',
      headers: Object.assign({}, jsonHeaders(), authHeader()),
      body: JSON.stringify({ rating, text })
    });
    const j = await res.json();
    if(!res.ok) throw new Error(j && j.error ? j.error : 'Error posting');
    out.textContent = 'Posted';
    loadReviews(productId);
  } catch(err){
    out.textContent = 'Failed: ' + (err.message||err);
  }
}

async function deleteReview(id){
  if(!confirm('Delete review?')) return;
  try {
    const res = await fetch(API_BASE + '/api/reviews/' + id, { method:'DELETE', headers: authHeader() });
    const j = await res.json();
    if(!res.ok) throw new Error(j && j.error ? j.error : 'Failed');
    alert('Deleted');
    // reload products area
    loadProducts(true);
  } catch(e){
    alert('Delete failed: ' + (e.message||e));
  }
}

/* --- Cart --- */
function loadCart(){ try { const raw = localStorage.getItem('nj_cart'); state.cart = raw ? JSON.parse(raw) : []; } catch(e){ state.cart = []; } renderCart(); }
function saveCart(){ localStorage.setItem('nj_cart', JSON.stringify(state.cart)); renderCart(); }
function addToCart(id, qty){
  const p = state.products.find(x=>x.id===id);
  if(!p){ alert('Product not found'); return; }
  const ex = state.cart.find(x=>x.id===id);
  if(ex) ex.qty += qty; else state.cart.push({ id:p.id, title:p.title, price:Number(p.price), qty });
  saveCart();
}
function renderCart(){
  const el = document.getElementById('cart-list');
  el.innerHTML = '';
  if(state.cart.length === 0){ el.innerHTML = '<div class="small">Cart empty</div>'; document.getElementById('cart-total').textContent = '—'; document.getElementById('cart-count').textContent = '0'; return; }
  let total = 0;
  for(const it of state.cart){
    total += it.price * it.qty;
    const row = document.createElement('div');
    row.className = 'cart-item';
    row.innerHTML = `<div>${escapeHtml(it.title)} <div class="small">${it.qty} × ${formatPrice(it.price)}</div></div><div style="text-align:right"><button class="btn ghost" onclick='changeQty("${it.id}",-1)'>-</button> <button class="btn ghost" onclick='changeQty("${it.id}",1)'>+</button></div>`;
    el.appendChild(row);
  }
  document.getElementById('cart-total').textContent = formatPrice(total);
  document.getElementById('cart-count').textContent = state.cart.reduce((s,i)=>s+i.qty,0);
}
function changeQty(id, delta){ const it = state.cart.find(x=>x.id===id); if(!it) return; it.qty += delta; if(it.qty<=0) state.cart = state.cart.filter(x=>x.id!==id); saveCart(); }

/* --- Checkout (server creates Stripe session and returns URL) --- */
async function checkout(){
  if(state.cart.length === 0){ alert('Cart empty'); return; }
  if(!state.token){ if(confirm('You must be logged in to checkout. Open login?')) openModal('login'); return; }
  const items = state.cart.map(i => ({ title: i.title, price: i.price, qty: i.qty }));
  document.getElementById('checkout-msg').textContent = 'Creating checkout session...';
  try {
    const res = await fetch(API_BASE + '/api/create-checkout-session', {
      method:'POST',
      headers: Object.assign({}, jsonHeaders(), authHeader()),
      body: JSON.stringify({ items })
    });
    const j = await res.json();
    if(!res.ok) throw new Error(j && j.error ? j.error : 'Failed to create session');
    if(j.url) window.location = j.url;
    else document.getElementById('checkout-msg').textContent = 'No session URL returned';
  } catch(err){
    document.getElementById('checkout-msg').textContent = 'Checkout error: ' + (err.message||err);
  }
}

/* --- Auth flows: check email, request code, register, login --- */
async function checkEmail(){
  const email = (document.getElementById('check-email').value || '').trim();
  if(!email) return alert('Enter email');
  try {
    const res = await fetch(API_BASE + '/api/auth/check-email?email=' + encodeURIComponent(email));
    const j = await res.json();
    document.getElementById('check-result').textContent = JSON.stringify(j, null, 2);
  } catch(e){
    document.getElementById('check-result').textContent = 'Check failed';
  }
}

async function requestCode(){
  const email = (document.getElementById('req-email').value || '').trim();
  if(!email) return alert('Enter email');
  try {
    const res = await fetch(API_BASE + '/api/auth/request-verify', { method:'POST', headers: jsonHeaders(), body: JSON.stringify({ email })});
    const j = await res.json();
    document.getElementById('req-result').textContent = JSON.stringify(j, null, 2);
    // convenience: if backend returns code (dev mode), prefill register modal if open
    if(j && j.code){
      const codeInput = document.querySelector('input[name="reg-code"]');
      if(codeInput) codeInput.value = j.code;
    }
  } catch(e){
    document.getElementById('req-result').textContent = 'Request failed';
  }
}

/* --- Modal (login/register) --- */
function openModal(mode){
  const root = document.getElementById('modal-root');
  root.innerHTML = '';
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop fade';
  const modal = document.createElement('div');
  modal.className = 'modal';
  if(mode === 'login'){
    modal.innerHTML = `<h3 style="margin:0 0 6px 0">Login</h3>
      <label>Email</label><input id="m-email" type="text" />
      <label>Password</label><input id="m-pass" type="password" />
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="m-close" class="btn ghost">Close</button>
        <button id="m-login" class="btn">Login</button>
      </div>
      <pre id="m-res" class="small" style="margin-top:8px"></pre>`;
    modal.querySelector('#m-close').onclick = ()=> root.innerHTML = '';
    modal.querySelector('#m-login').onclick = async () => {
      const email = modal.querySelector('#m-email').value.trim();
      const pw = modal.querySelector('#m-pass').value;
      if(!email || !pw) return alert('Email and password required');
      try {
        const res = await fetch(API_BASE + '/api/auth/login', { method:'POST', headers: jsonHeaders(), body: JSON.stringify({ email, password: pw })});
        const j = await res.json();
        modal.querySelector('#m-res').textContent = JSON.stringify(j, null, 2);
        if(res.ok && j.token){
          setToken(j.token);
          root.innerHTML = '';
          alert('Logged in');
        }
      } catch(e){ modal.querySelector('#m-res').textContent = 'Login failed'; }
    };
  } else {
    modal.innerHTML = `<h3 style="margin:0 0 6px 0">Register</h3>
      <label>Username</label><input name="reg-username" id="m-user" type="text" />
      <label>Email</label><input name="reg-email" id="m-email" type="text" />
      <label>Password</label><input name="reg-pass" id="m-pass" type="password" />
      <label>Verification code</label><input name="reg-code" id="m-code" type="text" />
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="m-close" class="btn ghost">Close</button>
        <button id="m-register" class="btn">Register</button>
      </div>
      <pre id="m-res" class="small" style="margin-top:8px"></pre>`;
    modal.querySelector('#m-close').onclick = ()=> root.innerHTML = '';
    modal.querySelector('#m-register').onclick = async () => {
      const username = modal.querySelector('#m-user').value.trim();
      const email = modal.querySelector('#m-email').value.trim();
      const pw = modal.querySelector('#m-pass').value;
      const code = modal.querySelector('#m-code').value.trim();
      if(!email || !pw || !code) return alert('Email, password and verification code required');
      try {
        const res = await fetch(API_BASE + '/api/auth/register', {
          method:'POST', headers: jsonHeaders(),
          body: JSON.stringify({ email, password: pw, verification_code: code, username })
        });
        const j = await res.json();
        modal.querySelector('#m-res').textContent = JSON.stringify(j, null, 2);
        if(res.ok && j.token){
          setToken(j.token);
          root.innerHTML = '';
          alert('Registered and logged in');
        }
      } catch(e){
        modal.querySelector('#m-res').textContent = 'Register failed';
      }
    };
  }
  backdrop.appendChild(modal);
  root.appendChild(backdrop);
}

/* header refresh */
function refreshHeader(){
  const el = document.getElementById('signed-as');
  if(state.token && state.user && state.user.email) el.textContent = 'Signed in: ' + state.user.email;
  else el.textContent = 'Not signed in';
}

/* utility to get auth headers */
function authHeader(){ return state.token ? { 'Authorization': 'Bearer ' + state.token } : {}; }

/* initial load */
(async function init(){
  await loadProducts();
  loadCart();
  renderCart();
  refreshHeader();
})();

/* cart persistence & rendering */
function loadCart(){
  try { const raw = localStorage.getItem('nj_cart'); state.cart = raw ? JSON.parse(raw) : []; } catch(e){ state.cart = []; }
}
function saveCart(){ localStorage.setItem('nj_cart', JSON.stringify(state.cart)); renderCart(); }
function renderCart(){ /* reuses earlier renderCart logic */ const el = document.getElementById('cart-list'); el.innerHTML = ''; if(state.cart.length===0){ el.innerHTML = '<div class="small">Cart empty</div>'; document.getElementById('cart-total').textContent = '—'; document.getElementById('cart-count').textContent = '0'; return; } let total=0; for(const it of state.cart){ total += it.price*it.qty; const row = document.createElement('div'); row.className = 'cart-item'; row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 0'; row.innerHTML = `<div>${escapeHtml(it.title)} <div class="small">${it.qty} × ${formatPrice(it.price)}</div></div><div style="display:flex;gap:6px"><button class="btn ghost" onclick='changeQty("${it.id}",-1)'>-</button><button class="btn ghost" onclick='changeQty("${it.id}",1)'>+</button></div>`; el.appendChild(row); } document.getElementById('cart-total').textContent = formatPrice(total); document.getElementById('cart-count').textContent = state.cart.reduce((s,i)=>s+i.qty,0); }

/* change qty */
function changeQty(id, delta){ const it = state.cart.find(x=>x.id===id); if(!it) return; it.qty += delta; if(it.qty<=0) state.cart = state.cart.filter(x=>x.id!==id); saveCart(); }

/* helpers for headers (authHeader already defined above) */
function authHeader(){ return state.token ? { 'Authorization': 'Bearer ' + state.token } : {}; }

/* keep cart persistent */
window.addEventListener('beforeunload', ()=> { saveCart(); });

</script>
</body>
</html>
