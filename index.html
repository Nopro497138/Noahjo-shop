<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Noahjo Shop — Galactic Storefront</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Noahjo Shop — Galactic gaming storefront demo" />
  <style>
    :root{ --bg-1:#040617; --bg-2:#071227; --accent-a:#6e47ff; --accent-b:#33c1ff; --accent-c:#ff7eb6; --muted:rgba(255,255,255,0.76); }
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,Arial; color:#eaf6ff; background: radial-gradient(1200px 600px at 10% 10%, rgba(110,71,255,0.12), transparent 7%), radial-gradient(800px 400px at 90% 90%, rgba(255,126,182,0.06), transparent 6%), linear-gradient(180deg,var(--bg-1),var(--bg-2)); -webkit-font-smoothing:antialiased; padding:18px}
    .stars{ position:fixed; inset:0; z-index:-3; background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), radial-gradient(rgba(255,255,255,0.02) 1px, transparent 1px); background-size:6px 6px,14px 14px; opacity:0.24 }
    .galaxy{ position:fixed; inset:0; z-index:-2; pointer-events:none }
    .blob{ position:absolute; border-radius:50%; filter: blur(60px); opacity:0.28; }
    .blob.a{ width:520px; height:520px; left:-120px; top:-80px; background: linear-gradient(135deg,var(--accent-a),var(--accent-b)); }
    .blob.b{ width:420px; height:420px; right:-80px; top:40px; background: linear-gradient(135deg,var(--accent-c),#7afcff); }

    .topbar{ position:sticky; top:0; display:flex; align-items:center; gap:16px; padding:12px 18px; backdrop-filter: blur(6px); background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border-bottom:1px solid rgba(255,255,255,0.03); z-index:50 }
    .brand{ display:flex; gap:12px; align-items:center; cursor:pointer }
    .logo{ width:54px; height:54px; border-radius:12px; display:grid; place-items:center; background: linear-gradient(135deg,var(--accent-a),var(--accent-b)); font-weight:800 }
    .brand h1{ margin:0; font-size:18px }
    .brand p{ margin:0; font-size:12px; color:var(--muted) }

    .wrap{ max-width:1200px; margin:18px auto; padding:0 18px 100px }
    .grid{ display:grid; grid-template-columns: 1fr 360px; gap:20px; align-items:start }
    @media (max-width:980px){ .grid{ grid-template-columns: 1fr } .top-actions{ display:none } }

    .card{ background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border-radius:14px; padding:16px; border:1px solid rgba(255,255,255,0.04); box-shadow: 0 10px 30px rgba(3,8,25,0.2) }

    .products-grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(240px,1fr)); gap:16px; margin-top:12px }
    .product-card{ border-radius:12px; overflow:hidden; transition: transform .28s cubic-bezier(.2,.9,.2,1), box-shadow .28s; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); cursor:pointer }
    .product-card:hover{ transform:translateY(-10px) rotate(-0.6deg); box-shadow: 0 30px 80px rgba(0,0,0,0.6) }
    .product-media{ width:100%; height:160px; object-fit:cover; background:#061224 }
    .product-body{ padding:12px; display:flex; gap:12px; align-items:center; justify-content:space-between }
    .meta h3{ margin:0; font-size:16px }
    .meta p{ margin:6px 0 0 0; font-size:13px; color:var(--muted) }
    .price{ font-weight:800; font-size:16px }

    .category-pills{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px }
    .pill{ padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.02); cursor:pointer; transition: transform .12s }
    .pill:hover{ transform:translateY(-3px) }
    .pill.active{ background: linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:white }

    .modal-backdrop{ position:fixed; inset:0; background:rgba(2,6,18,0.72); display:flex; align-items:center; justify-content:center; z-index:9999; padding:20px }
    .modal{ width:100%; max-width:980px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015)); border-radius:14px; padding:18px; border:1px solid rgba(255,255,255,0.04); max-height:86vh; overflow:auto; animation: pop .18s ease }
    @keyframes pop{ from{ transform:translateY(8px) scale(.99); opacity:0 } to{ transform:none; opacity:1 } }
    .carousel{ position:relative; border-radius:12px; overflow:hidden; background:#020617; min-height:300px; display:flex; align-items:center; justify-content:center }
    .carousel img{ width:100%; height:100%; object-fit:cover }
    .arrow{ position:absolute; top:50%; transform:translateY(-50%); background: rgba(0,0,0,0.35); border:none; color:white; padding:10px; border-radius:50%; cursor:pointer }
    .arrow.left{ left:10px } .arrow.right{ right:10px }
    .dots{ position:absolute; bottom:10px; left:50%; transform:translateX(-50%); display:flex; gap:6px }

    .tabbar{ display:flex; gap:8px; margin-top:10px }
    .tabbar button{ padding:6px 10px; border-radius:8px; background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.02) }
    .tabbar button.active{ background:linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:white }

    .cart-list{ margin-top:12px; display:flex; flex-direction:column; gap:8px }
    .cart-item{ display:flex; gap:10px; align-items:center; justify-content:space-between; padding:8px; border-radius:10px; background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02) }

    .chat-box{ display:flex; flex-direction:column; gap:8px; border-radius:8px; background:rgba(0,0,0,0.18); padding:8px; max-height:380px; overflow:auto }
    .message{ padding:8px; border-radius:8px; background:rgba(255,255,255,0.02); }

    .inline-msg{ margin-top:10px; padding:10px; border-radius:8px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); color:var(--muted) }

    input, textarea { background:transparent; border:1px solid rgba(255,255,255,0.04); padding:8px; border-radius:8px; color:inherit }
    button{ border:0; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700; background: linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:white }
    button.ghost{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.06) }
    .tiny{ font-size:12px; color:var(--muted) }

    .drawer{ position:fixed; right:0; top:0; height:100%; width:380px; max-width:92vw; background:linear-gradient(180deg, rgba(4,6,20,0.96), rgba(2,8,12,0.98)); box-shadow: -30px 0 80px rgba(0,0,0,0.6); transform:translateX(100%); transition: transform .26s cubic-bezier(.2,.9,.2,1); z-index:120 }
    .drawer.open{ transform:translateX(0); }
    .row{ display:flex; gap:12px; align-items:center }
  </style>
</head>
<body>
  <div class="stars" aria-hidden></div>
  <div class="galaxy"><div class="blob a"></div><div class="blob b"></div></div>

  <div class="topbar">
    <div class="brand" id="brand" role="button">
      <div class="logo">NJ</div>
      <div>
        <h1>Noahjo Shop</h1>
        <p class="tiny">Galactic Gaming Gear</p>
      </div>
    </div>

    <div class="top-actions" id="top-actions">
      <div id="signed-as" class="tiny">Not signed in</div>
      <button id="btn-login" class="ghost">Login</button>
      <button id="btn-register">Register</button>
      <button id="btn-cart" class="ghost">Cart (<span id="cart-count">0</span>)</button>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <main>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong style="font-size:18px">Products</strong>
            </div>
            <div style="display:flex;align-items:center;gap:10px">
              <input id="search" type="text" placeholder="Search products..." style="width:260px" />
              <button id="btn-refresh" class="ghost">Refresh</button>
            </div>
          </div>

          <div id="categories" class="category-pills"></div>
          <div id="products-root" class="products-grid"></div>
        </div>

        <div id="product-detail-area" style="margin-top:16px"></div>
      </main>

      <aside>
        <div class="card">
          <strong>Cart</strong>
          <div id="cart-list" class="cart-list"></div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
            <div class="tiny">Subtotal</div>
            <div id="cart-total" style="font-weight:800">—</div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="btn-checkout">Checkout</button>
            <button id="btn-clear" class="ghost">Clear</button>
          </div>

          <div id="checkout-msg" class="inline-msg" style="display:none"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <strong>Account</strong>
          <div class="tiny" style="margin-top:8px">Register / login to review & checkout.</div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button id="acct-login" class="pill">Login</button>
            <button id="acct-register" class="pill">Register</button>
          </div>
          <div id="acct-info" style="margin-top:12px"></div>
        </div>
      </aside>
    </div>

    <footer style="margin-top:20px;text-align:center;color:rgba(255,255,255,0.65);font-size:13px">© Noahjo Shop — Galactic Demo</footer>
  </div>

  <div id="modal-root" aria-live="polite"></div>
  <div id="cart-drawer" class="drawer" aria-hidden="true"></div>

  <script>
  // ---------- CONFIG / SEED ----------
  const SEED_PRODUCTS = [
    { id: 'prod-1', title: 'Nebula Headset', category: 'Accessories', price: 79.99, short_desc: 'Wireless headset with spatial audio and nebula lighting.', long_desc: 'Immersive over-ear headset built for long sessions. 50mm drivers, low-latency wireless mode, breathable cushions and nebula RGB.', images: ['/images/headset-1.jpg','/images/headset-2.jpg'] },
    { id: 'prod-2', title: 'Void Runner Hoodie', category: 'Apparel', price: 49.99, short_desc: 'Comfort-fit hoodie with glow-in-dark print.', long_desc: 'Premium cotton-blend hoodie with reflective galaxy print.', images: ['/images/hoodie-1.jpg'] },
    { id: 'prod-3', title: 'Meteor Grip', category: 'Accessories', price: 12.99, short_desc: 'Tactile grip add-on.', long_desc: 'Slim profile grip with anti-slip texture.', images: ['/images/grip-1.jpg'] },
    { id: 'prod-4', title: 'Cosmo Lamp', category: 'Gear', price: 34.99, short_desc: 'Ambient lamp projecting soft galaxy patterns.', long_desc: 'USB-C powered lamp with multiple brightness modes.', images: ['/images/lamp-1.jpg'] }
  ];

  // Backend config: set window.API_BASE before loading page if backend is remote
  const API_BASE = (window.API_BASE || location.origin).replace(/\/$/, '');
  const USE_API = true; // flip to false to run purely local demo

  const TOKEN_KEY = 'nj_token';
  let state = { token: localStorage.getItem(TOKEN_KEY) || null, user: null, products: [], cart: [] };

  function parseJwt(token){ try{ const p = token.split('.')[1]; return JSON.parse(atob(p.replace(/-/g,'+').replace(/_/g,'/'))); }catch(e){ return null } }
  function setToken(token){ state.token = token; if(token) localStorage.setItem(TOKEN_KEY, token); else localStorage.removeItem(TOKEN_KEY); state.user = token ? parseJwt(token) : null; refreshHeader(); }
  setToken(state.token);

  function el(q){ return document.querySelector(q); }
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>\"]/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  function formatPrice(p){ return '$' + Number(p).toFixed(2); }
  function authHeader(){ return state.token ? { 'Authorization': 'Bearer ' + state.token } : {}; }
  function jsonHeaders(){ return { 'Content-Type': 'application/json' }; }

  function showInlineMsg(text, timeout=6000){ const elMsg = el('#checkout-msg'); if(!elMsg) return; elMsg.style.display = 'block'; elMsg.textContent = text; if(timeout) setTimeout(()=>{ elMsg.style.display = 'none'; }, timeout); }

  // ---------- PRODUCTS ----------
  async function loadProducts(){ const root = el('#products-root'); root.innerHTML = '<div class="tiny">Loading…</div>'; if(USE_API){ try{ const res = await fetch(API_BASE + '/api/products'); if(res.ok){ const data = await res.json(); state.products = (Array.isArray(data) && data.length) ? data : SEED_PRODUCTS.slice(); renderCategories(); renderProductCards(); return; } }catch(e){ /* silent fallback to seed */ } }
    state.products = SEED_PRODUCTS.slice(); renderCategories(); renderProductCards(); }

  function renderCategories(){ const root = el('#categories'); root.innerHTML = ''; const cats = Array.from(new Set(state.products.map(p=>p.category||'Other'))).filter(Boolean).sort(); const all = document.createElement('button'); all.className='pill active'; all.textContent='All'; all.onclick = ()=>{ document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active')); all.classList.add('active'); renderProductCards(); }; root.appendChild(all); for(const c of cats){ const b=document.createElement('button'); b.className='pill'; b.textContent=c; b.onclick = ()=>{ document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderProductCards(); }; root.appendChild(b); } }

  function renderProductCards(){ const root = el('#products-root'); root.innerHTML=''; const q = (el('#search').value||'').trim().toLowerCase(); let activeCat=null; document.querySelectorAll('.pill').forEach(p=>{ if(p.classList.contains('active') && p.textContent!=='All') activeCat=p.textContent; }); const filtered = state.products.filter(p=>{ if(activeCat && activeCat!=='All' && (p.category||'') !== activeCat) return false; if(!q) return true; return p.title.toLowerCase().includes(q) || (p.category||'').toLowerCase().includes(q) || (p.short_desc||'').toLowerCase().includes(q); }); if(filtered.length===0){ root.innerHTML = '<div class="tiny">No products found.</div>'; return; }
    for(const p of filtered){ const card = document.createElement('div'); card.className='product-card'; const img=(p.images&&p.images[0])?p.images[0]:'/images/headset-1.jpg'; card.innerHTML = `
      <div style="height:160px;overflow:hidden;background:#020617"><img class="product-media" src="${escapeHtml(img)}" alt="${escapeHtml(p.title)}" /></div>
      <div class="product-body">
        <div class="meta">
          <h3>${escapeHtml(p.title)}</h3>
          <p>${escapeHtml(p.short_desc||'')}</p>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
          <div class="price">${formatPrice(p.price)}</div>
          <div style="display:flex;gap:8px">
            <button class="ghost">Open</button>
            <button>Add</button>
          </div>
        </div>
      </div>`;
      // attach handlers directly
      const openBtn = card.querySelector('button.ghost'); const addBtn = card.querySelectorAll('button')[1];
      openBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openProduct(p.id); });
      addBtn.addEventListener('click', (e)=>{ e.stopPropagation(); addToCart(p.id,1); });
      card.addEventListener('click', ()=> openProduct(p.id));
      root.appendChild(card);
    }
  }

  // ---------- PRODUCT DETAIL (modal) ----------
  function openProduct(id){ const p = state.products.find(x=>x.id===id); if(!p) return; const root = el('#modal-root'); root.innerHTML = ''; const backdrop = document.createElement('div'); backdrop.className='modal-backdrop'; const modal = document.createElement('div'); modal.className='modal'; const imgs = (p.images&&p.images.length)?p.images:['/images/headset-1.jpg']; modal.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center"><div><h2 style="margin:0">${escapeHtml(p.title)}</h2><div class="tiny">${escapeHtml(p.category||'')}</div></div><div style="display:flex;gap:8px;align-items:center"><div style="font-weight:800">${formatPrice(p.price)}</div><button class="ghost" id="close-detail">Close</button></div></div>
    <div style="margin-top:12px;display:grid;grid-template-columns:1fr 360px;gap:12px"> <div> <div class="carousel" id="carousel-root"><button class="arrow left" id="c-left" style="display:none">‹</button><img id="c-img" src="${escapeHtml(imgs[0])}" alt="${escapeHtml(p.title)}" /><button class="arrow right" id="c-right" style="display:none">›</button><div class="dots" id="c-dots"></div></div><div class="tabbar"><button id="tab-details" class="active">Details</button><button id="tab-reviews">Reviews</button></div></div>
    <div><div id="tab-content"><div id="details-pane"><p class="tiny" style="white-space:pre-line">${escapeHtml(p.long_desc||p.short_desc||'')}</p><div style="margin-top:12px;display:flex;gap:8px"><button id="add-to-cart-detail">Add to cart</button><button id="buy-now" class="ghost">Buy now</button></div></div><div id="reviews-pane" style="display:none"><div id="reviews-list" class="reviews-list"></div><div id="review-form" style="margin-top:12px"></div></div></div></div></div>`;
    backdrop.appendChild(modal); root.appendChild(backdrop);

    // carousel
    let idx = 0; const imgEl = modal.querySelector('#c-img'); const left = modal.querySelector('#c-left'); const right = modal.querySelector('#c-right'); const dots = modal.querySelector('#c-dots'); function renderDots(){ dots.innerHTML=''; imgs.forEach((_,i)=>{ const d = document.createElement('button'); d.style.width='8px'; d.style.height='8px'; d.style.borderRadius='50%'; d.style.margin='0 4px'; d.style.border='none'; d.style.background = i===idx ? 'white' : 'rgba(255,255,255,0.18)'; d.onclick = ()=>{ idx = i; updateCarousel(); }; dots.appendChild(d); }); }
    function updateCarousel(){ imgEl.src = imgs[idx]; if(imgs.length>1){ left.style.display='block'; right.style.display='block'; } else { left.style.display='none'; right.style.display='none'; } renderDots(); }
    left.onclick = e=>{ e.stopPropagation(); idx=(idx-1+imgs.length)%imgs.length; updateCarousel(); }
    right.onclick = e=>{ e.stopPropagation(); idx=(idx+1)%imgs.length; updateCarousel(); }
    updateCarousel();

    // tabs + reviews
    const tabD = modal.querySelector('#tab-details'); const tabR = modal.querySelector('#tab-reviews'); const detPane = modal.querySelector('#details-pane'); const revPane = modal.querySelector('#reviews-pane'); tabD.onclick = ()=>{ tabD.classList.add('active'); tabR.classList.remove('active'); detPane.style.display='block'; revPane.style.display='none'; }
    tabR.onclick = async ()=>{ tabR.classList.add('active'); tabD.classList.remove('active'); detPane.style.display='none'; revPane.style.display='block'; await loadReviews(p.id); }

    async function loadReviews(productId){ const list = modal.querySelector('#reviews-list'); list.innerHTML = '<div class="tiny">Loading…</div>';
      if(USE_API){ try{ const res = await fetch(API_BASE + '/api/products/' + encodeURIComponent(productId) + '/reviews'); if(res.ok){ const rows = await res.json(); renderRows(rows); return; } }catch(e){ /* fallback */ } }
      const local = JSON.parse(localStorage.getItem('nj_reviews_' + productId) || '[]'); renderRows(local);
      function renderRows(rows){ list.innerHTML=''; if(!rows || rows.length===0) list.innerHTML = '<div class="tiny">No reviews yet</div>'; else{ rows.forEach(r=>{ const block = document.createElement('div'); block.className='review'; block.innerHTML = `<div style="display:flex;justify-content:space-between;font-weight:700;color:var(--muted)"><div>${escapeHtml(r.author_email||r.author||'User')}</div><div>${r.rating}★</div></div><div style="margin-top:8px">${escapeHtml(r.text||'')}</div>`; if(r._canDelete){ const btn = document.createElement('button'); btn.className='ghost'; btn.style.marginTop='8px'; btn.textContent='Delete'; btn.onclick = ()=>{ if(!confirm('Delete review?')) return; deleteReviewLocal(productId, r._localId || r.id); loadReviews(productId); }; block.appendChild(btn); } list.appendChild(block); }); } }

      const form = modal.querySelector('#review-form'); if(state.token){ form.innerHTML = `<label class="tiny">Rating (1-5)</label><input id="modal-rev-rating" type="number" min="1" max="5" value="5" style="width:100%;margin-top:6px" /><label class="tiny" style="margin-top:8px">Review</label><textarea id="modal-rev-text" rows="3" style="width:100%;margin-top:6px"></textarea><div style="margin-top:8px"><button id="modal-post-rev">Post review</button></div><pre id="modal-rev-res" class="tiny" style="margin-top:6px"></pre>`; modal.querySelector('#modal-post-rev').onclick = async ()=>{ const rating = Number(modal.querySelector('#modal-rev-rating').value||5); const text = modal.querySelector('#modal-rev-text').value||''; try{ const r = await fetch(API_BASE + '/api/products/' + encodeURIComponent(productId) + '/reviews', { method:'POST', headers: Object.assign({}, jsonHeaders(), authHeader()), body: JSON.stringify({ rating, text }) }); const j = await r.json(); if(!r.ok) throw new Error(j && j.error ? j.error : 'Failed'); modal.querySelector('#modal-rev-res').textContent = 'Posted'; await loadReviews(productId); }catch(err){ modal.querySelector('#modal-rev-res').textContent = 'Error: ' + (err.message||err); } }; } else { form.innerHTML = '<div class="tiny">Login to post reviews.</div>'; }
    }

    modal.querySelector('#add-to-cart-detail').onclick = ()=>{ addToCart(p.id,1); showInlineMsg('Added to cart'); };
    modal.querySelector('#buy-now').onclick = async ()=>{ addToCart(p.id,1); await checkout(); };
    modal.querySelector('#close-detail').onclick = ()=>{ root.innerHTML = ''; };
    backdrop.addEventListener('click', ev=>{ if(ev.target === backdrop) root.innerHTML = ''; });
  }

  function deleteReviewLocal(productId, localId){ const key = 'nj_reviews_' + productId; const arr = JSON.parse(localStorage.getItem(key) || '[]'); const filtered = arr.filter(r=>!(r._localId && String(r._localId) === String(localId))); localStorage.setItem(key, JSON.stringify(filtered)); }

  // ---------- CART ----------
  function loadCart(){ try{ const raw = localStorage.getItem('nj_cart'); state.cart = raw ? JSON.parse(raw) : []; }catch(e){ state.cart = []; } renderCart(); }
  function saveCart(){ localStorage.setItem('nj_cart', JSON.stringify(state.cart)); renderCart(); }
  function addToCart(id, qty){ const p = state.products.find(x=>x.id===id); if(!p){ showInlineMsg('Product not found'); return; } const ex = state.cart.find(x=>x.id===id); if(ex) ex.qty += qty; else state.cart.push({ id:p.id, title:p.title, price:Number(p.price), qty }); saveCart(); openDrawer(); }
  function changeQty(id, delta){ const it = state.cart.find(x=>x.id===id); if(!it) return; it.qty += delta; if(it.qty<=0) state.cart = state.cart.filter(x=>x.id!==id); saveCart(); }

  function renderCart(){ const el = el('#cart-list'); if(!el) return; el.innerHTML=''; if(!state.cart || state.cart.length===0){ el.innerHTML = '<div class="tiny">Cart empty</div>'; el('#cart-total') && (el('#cart-total').textContent = '—'); document.getElementById('cart-count').textContent='0'; return; } let total=0; for(const it of state.cart){ total += it.price*it.qty; const row = document.createElement('div'); row.className='cart-item'; const thumb = (state.products.find(p=>p.id===it.id)||{}).images?.[0]||'/images/headset-1.jpg'; row.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><img src="${escapeHtml(thumb)}" style="width:56px;height:40px;object-fit:cover;border-radius:8px"/><div><div style="font-weight:700">${escapeHtml(it.title)}</div><div class="tiny">${it.qty} × ${formatPrice(it.price)}</div></div></div><div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px"><div style="font-weight:800">${formatPrice(it.price*it.qty)}</div><div style="display:flex;gap:6px"><button class="ghost" data-dec="${it.id}">-</button><button class="ghost" data-inc="${it.id}">+</button></div></div>`; el.appendChild(row); }
    el.querySelectorAll('[data-dec]').forEach(b=> b.addEventListener('click', ()=> changeQty(b.getAttribute('data-dec'), -1)));
    el.querySelectorAll('[data-inc]').forEach(b=> b.addEventListener('click', ()=> changeQty(b.getAttribute('data-inc'), 1)));
    el.querySelectorAll('[data-remove]').forEach(b=> b.addEventListener('click', ()=> { state.cart = state.cart.filter(x=>x.id!==b.getAttribute('data-remove')); saveCart(); }));
    el('#cart-total') && (el('#cart-total').textContent = formatPrice(total));
    document.getElementById('cart-count').textContent = state.cart.reduce((s,i)=>s+i.qty,0);
  }

  // --- drawer UI ---
  function openDrawer(){ const d = document.getElementById('cart-drawer'); if(!d) return; d.classList.add('open'); d.setAttribute('aria-hidden','false'); renderDrawer(); }
  function closeDrawer(){ const d = document.getElementById('cart-drawer'); if(!d) return; d.classList.remove('open'); d.setAttribute('aria-hidden','true'); }
  function renderDrawer(){ const d = document.getElementById('cart-drawer'); d.innerHTML = ''; const header = document.createElement('div'); header.style.padding='16px'; header.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0">Your Cart</h3><button id="drawer-close" class="ghost">Close</button></div>`; d.appendChild(header);
    const body = document.createElement('div'); body.style.padding='16px'; body.style.maxHeight='calc(100% - 220px)'; body.style.overflow='auto'; if(state.cart.length===0){ body.innerHTML = '<div class="tiny">Your cart is empty.</div>'; } else { const box = document.createElement('div'); box.style.display='grid'; box.style.gap='12px'; state.cart.forEach(item=>{ const row = document.createElement('div'); row.className='card'; row.style.display='flex'; row.style.alignItems='center'; row.style.justifyContent='space-between'; row.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div style="width:48px;height:48px;border-radius:8px;background:linear-gradient(90deg,var(--accent-a),var(--accent-b));display:grid;place-items:center;font-weight:700">${escapeHtml(item.title.split(' ')[0].slice(0,2))}</div><div><div style="font-weight:700">${escapeHtml(item.title)}</div><div class="tiny">${formatPrice(item.price)}</div></div></div><div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px"><input type="number" min="1" value="${item.qty}" data-qty="${item.id}" style="width:64px;border-radius:8px;padding:6px;text-align:center;color:#000"/><button class="ghost" data-remove="${item.id}">Remove</button></div>`; box.appendChild(row); }); body.appendChild(box); }
    d.appendChild(body);
    const footer = document.createElement('div'); footer.style.padding='16px'; footer.innerHTML = `<div style="border-top:1px solid rgba(255,255,255,0.04);padding-top:12px"><div style="display:flex;justify-content:space-between;align-items:center"><div class="tiny">Subtotal</div><div style="font-weight:800">${formatPrice(state.cart.reduce((s,i)=>s+i.price*i.qty,0)||0)}</div></div><div style="margin-top:12px;display:flex;gap:8px"><button id="drawer-checkout" style="flex:1">Checkout</button><button id="drawer-clear" class="ghost">Clear</button></div></div>`; d.appendChild(footer);

    // wire up drawer buttons
    d.querySelectorAll('[data-qty]').forEach(inp=> inp.addEventListener('change', ()=>{ const id = inp.getAttribute('data-qty'); const v = Math.max(1, Number(inp.value||1)); const curr = (state.cart.find(x=>x.id===id)||{}).qty || 0; changeQty(id, v - curr); renderDrawer(); }));
    d.querySelectorAll('[data-remove]').forEach(b=> b.addEventListener('click', ()=>{ state.cart = state.cart.filter(x=>x.id!==b.getAttribute('data-remove')); saveCart(); renderDrawer(); }));
    d.querySelector('#drawer-close').onclick = ()=> closeDrawer();
    d.querySelector('#drawer-clear').onclick = ()=>{ state.cart = []; saveCart(); renderDrawer(); };
    d.querySelector('#drawer-checkout').onclick = ()=> checkout();
  }

  // --- checkout (Stripe) ---
  async function checkout(){ if(state.cart.length===0){ showInlineMsg('Your cart is empty — add items before checkout.'); return; } if(!state.token){ showInlineMsg('Please log in to proceed to checkout.'); openModal('login'); return; } const items = state.cart.map(i=>({ id:i.id, title:i.title, price:i.price, qty:i.qty })); el('#checkout-msg').textContent = 'Creating checkout session...'; el('#checkout-msg').style.display = 'block'; if(USE_API){ try{ const res = await fetch(API_BASE + '/api/create-checkout-session', { method:'POST', headers: Object.assign({}, jsonHeaders(), authHeader()), body: JSON.stringify({ items }) }); const j = await res.json(); if(!res.ok) throw new Error(j && j.error ? j.error : 'Failed'); if(j.url){ window.location.href = j.url; } else { showInlineMsg('No checkout URL returned from server.'); } }catch(err){ showInlineMsg('Checkout error: ' + (err.message||err)); } } else { showInlineMsg('Checkout requires backend. Enable server to complete payment.'); } }

  // --- auth API wrappers ---
  async function apiRegister(email,password,code){ if(!USE_API) return { ok:false, error:'Enable server to register' }; try{ const res = await fetch(API_BASE + '/api/auth/register', { method:'POST', headers: jsonHeaders(), body: JSON.stringify({ email, password, verification_code: code }) }); const j = await res.json(); if(!res.ok) return { ok:false, error: j && j.error ? j.error : 'Register failed' }; return { ok:true, token: j.token }; }catch(e){ return { ok:false, error:'Network error: unable to reach ' + API_BASE }; } }
  async function apiLogin(email,password){ if(!USE_API) return { ok:false, error:'Enable server to login' }; try{ const res = await fetch(API_BASE + '/api/auth/login', { method:'POST', headers: jsonHeaders(), body: JSON.stringify({ email, password }) }); const j = await res.json(); if(!res.ok) return { ok:false, error: j && j.error ? j.error : 'Login failed' }; return { ok:true, token: j.token }; }catch(e){ return { ok:false, error:'Network error: unable to reach ' + API_BASE }; } }
  async function requestVerifyCode(email){ if(!USE_API) return { ok:false, error:'Server required to send verification email' }; try{ const res = await fetch(API_BASE + '/api/auth/request-verify', { method:'POST', headers: jsonHeaders(), body: JSON.stringify({ email }) }); const j = await res.json(); if(!res.ok) return { ok:false, error: j && j.error ? j.error : 'Request failed' }; return { ok:true, info: j }; }catch(e){ return { ok:false, error:'Network error: unable to reach ' + API_BASE }; } }

  // --- modal login/register (two-step register) ---
  function openModal(mode){ const root = el('#modal-root'); root.innerHTML=''; const backdrop = document.createElement('div'); backdrop.className='modal-backdrop'; const box = document.createElement('div'); box.className='modal';

    function renderCodeEntry(email,password){ box.innerHTML = `<h3>Enter verification code</h3><div style="margin-top:8px">We've sent a code to <strong>${escapeHtml(email)}</strong>. Check your inbox (and spam).</div><div style="margin-top:8px"><input id="confirm-code" placeholder="Enter verification code" /></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="code-cancel" class="ghost">Cancel</button><button id="code-confirm">Confirm & Register</button></div><pre id="code-res" class="tiny" style="margin-top:8px"></pre>`;
      box.querySelector('#code-cancel').onclick = ()=> root.innerHTML = '';
      box.querySelector('#code-confirm').onclick = async ()=>{ const code = box.querySelector('#confirm-code').value.trim(); if(!code){ box.querySelector('#code-res').textContent = 'Enter the code you received'; return; } box.querySelector('#code-res').textContent = 'Registering...'; const res = await apiRegister(email,password,code); if(!res.ok){ box.querySelector('#code-res').textContent = res.error; } else { setToken(res.token); root.innerHTML = ''; showInlineMsg('Registered and logged in'); } }
    }

    if(mode === 'login'){
      box.innerHTML = `<h3>Login</h3><div style="margin-top:10px"><input id="m-email" placeholder="email" /></div><div style="margin-top:8px"><input id="m-pass" placeholder="password" type="password" /></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="m-close" class="ghost">Close</button><button id="m-login">Login</button></div><pre id="m-res" class="tiny" style="margin-top:8px"></pre>`;
      backdrop.appendChild(box); root.appendChild(backdrop);
      box.querySelector('#m-close').onclick = ()=> root.innerHTML = ''; 
      box.querySelector('#m-login').onclick = async ()=>{ const email = box.querySelector('#m-email').value.trim(); const pw = box.querySelector('#m-pass').value; if(!email||!pw){ box.querySelector('#m-res').textContent = 'Email & password required'; return; } box.querySelector('#m-res').textContent = 'Logging in...'; const r = await apiLogin(email,pw); if(!r.ok){ box.querySelector('#m-res').textContent = r.error; } else { setToken(r.token); root.innerHTML = ''; showInlineMsg('Logged in'); } };
    } else {
      box.innerHTML = `<h3>Register</h3><div style="margin-top:10px"><input id="r-email" placeholder="email" /></div><div style="margin-top:8px"><input id="r-pass" placeholder="password" type="password" /></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="r-close" class="ghost">Close</button><button id="r-send-code">Send code</button></div><pre id="r-res" class="tiny" style="margin-top:8px"></pre>`;
      backdrop.appendChild(box); root.appendChild(backdrop);
      box.querySelector('#r-close').onclick = ()=> root.innerHTML = '';
      box.querySelector('#r-send-code').onclick = async ()=>{ const email = box.querySelector('#r-email').value.trim(); const pw = box.querySelector('#r-pass').value; if(!email || !pw){ box.querySelector('#r-res').textContent = 'Email and password are required'; return; } box.querySelector('#r-res').textContent = 'Sending verification code...'; const r = await requestVerifyCode(email); if(!r.ok){ box.querySelector('#r-res').textContent = r.error + ' — If your backend is on a different host, set window.API_BASE before loading this page.'; } else { renderCodeEntry(email,pw); } };
    }

    backdrop.addEventListener('click', ev=>{ if(ev.target===backdrop) root.innerHTML = ''; });
  }

  // --- post-checkout handler & local chat fallback ---
  async function handleCheckoutReturn(){ try{ const url = new URL(location.href); const s = url.searchParams.get('checkout_success'); const session_id = url.searchParams.get('session_id'); if(s && session_id){ if(USE_API){ try{ const res = await fetch(API_BASE + '/api/orders/by-session/' + encodeURIComponent(session_id)); if(res.ok){ const order = await res.json(); state.cart = []; saveCart(); openChatModal(order.id, order.user_email || (state.user && state.user.email)); url.searchParams.delete('checkout_success'); url.searchParams.delete('session_id'); history.replaceState({}, document.title, url.toString()); return; } }catch(e){ /* fallback */ } }
        const orders = JSON.parse(localStorage.getItem('nj_demo_orders')||'[]'); const ord = orders.find(o=>o.stripe_session_id===session_id); if(ord){ state.cart=[]; saveCart(); openChatModal(ord.id, ord.user_email); url.searchParams.delete('checkout_success'); url.searchParams.delete('session_id'); history.replaceState({}, document.title, url.toString()); }
    } }catch(e){ console.error(e); } }

  function openChatModal(orderId, partnerEmail){ const root = el('#modal-root'); root.innerHTML=''; const b = document.createElement('div'); b.className='modal-backdrop'; const box = document.createElement('div'); box.className='modal'; box.innerHTML = `<h3>Order #${orderId} — Chat</h3><div style="margin-top:12px" id="chat-messages" class="chat-box"></div><div style="display:flex;gap:8px;margin-top:8px"><input id="chat-input" placeholder="Message..." style="flex:1" /><button id="chat-send">Send</button></div>`; b.appendChild(box); root.appendChild(b);
    const key = 'nj_chat_order_' + orderId; const messages = JSON.parse(localStorage.getItem(key)||'[]'); const list = box.querySelector('#chat-messages'); list.innerHTML = ''; messages.forEach(m=>{ const elm = document.createElement('div'); elm.className='message'; elm.innerHTML = `<div style="font-size:12px;color:var(--muted)">${escapeHtml(m.sender||'user')} • ${new Date(m.created_at).toLocaleString()}</div><div style="margin-top:6px">${escapeHtml(m.text)}</div>`; list.appendChild(elm); }); box.querySelector('#chat-send').onclick = ()=>{ const text = box.querySelector('#chat-input').value.trim(); if(!text) return; const msg = { sender: (state.user&&state.user.email)||'you', text, created_at: new Date().toISOString() }; messages.push(msg); localStorage.setItem(key, JSON.stringify(messages)); const elm = document.createElement('div'); elm.className='message'; elm.innerHTML = `<div style="font-size:12px;color:var(--muted)">${escapeHtml(msg.sender)} • ${new Date(msg.created_at).toLocaleString()}</div><div style="margin-top:6px">${escapeHtml(msg.text)}</div>`; list.appendChild(elm); box.querySelector('#chat-input').value=''; list.scrollTop = list.scrollHeight; };
    b.addEventListener('click', ev=>{ if(ev.target===b) root.innerHTML=''; }); }

  // --- header refresh ---
  function refreshHeader(){ const elm = document.getElementById('signed-as'); if(state.token && state.user && state.user.email) elm.textContent = 'Signed in: ' + state.user.email; else elm.textContent = 'Not signed in'; const acctInfo = document.getElementById('acct-info'); if(state.token && state.user){ acctInfo.innerHTML = `<div class="tiny">${escapeHtml(state.user.email)}</div><div style="margin-top:8px"><button class="ghost" id="logout">Logout</button></div>`; document.getElementById('logout').onclick = ()=>{ setToken(null); }; } else { acctInfo.innerHTML=''; } }

  // --- UI bindings & init ---
  document.addEventListener('DOMContentLoaded', ()=>{
    el('#btn-refresh').addEventListener('click', ()=> loadProducts());
    el('#btn-login').addEventListener('click', ()=> openModal('login'));
    el('#btn-register').addEventListener('click', ()=> openModal('register'));
    el('#acct-login').addEventListener('click', ()=> openModal('login'));
    el('#acct-register').addEventListener('click', ()=> openModal('register'));
    el('#btn-clear').addEventListener('click', ()=> { state.cart = []; saveCart(); renderCart(); });
    el('#btn-checkout').addEventListener('click', ()=> checkout());
    el('#btn-cart').addEventListener('click', ()=> openDrawer());
    el('#search').addEventListener('input', ()=> renderProductCards());

    (async function init(){ await loadProducts(); try{ const raw = localStorage.getItem('nj_cart'); state.cart = raw?JSON.parse(raw):[]; }catch(e){ state.cart=[]; } renderCart(); try{ const t = localStorage.getItem(TOKEN_KEY); state.user = t?parseJwt(t):null; }catch(e){} refreshHeader(); await handleCheckoutReturn(); })();

    // close drawer when clicking outside
    document.addEventListener('click', (ev)=>{ const d = document.getElementById('cart-drawer'); if(!d) return; if(d.classList.contains('open')){ const inside = d.contains(ev.target); const btn = el('#btn-cart'); if(!inside && ev.target !== btn) closeDrawer(); } });

  });

  window.addEventListener('beforeunload', ()=>{ try{ localStorage.setItem('nj_cart', JSON.stringify(state.cart)); }catch(e){} });
  </script>
</body>
</html>
